{% extends "base.html" %}
{% load static %}
{% block body %}

<!-- Cards in the same row -->

<header>
  <div class="mx-5 px-5">
    <h4 class="my-5" style="position: absolute; color: #eef4fc;">Welcome</4>
  </div>
</header>
<hr id="hr1">

<div class="mx-5 px-5 mt-5">

  <h5 class="my-4" style="color: #d4e4f9;">Services</h5>
  <div class="row">
    <div class="col-md-6">
      <div class="card text-light">

        <div class="card-body">
          <h5 class="card-title">Item 1</h5>
          <p class="card-text">Description of item 1.</p>
          <button type="button" class="btn btn-success mt-3" data-toggle="modal" data-target="#lendModal">
            Lend
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-light">
        <div class="card-body">
          <h5 class="card-title">Item A</h5>
          <p class="card-text">Description of item A.</p>
          <button type="button" class="btn btn-success mt-3" data-toggle="modal" data-target="#BorrowModal">
            Borrow
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lend Modal -->
  <div class="modal fade" id="lendModal" tabindex="-1" role="dialog" aria-labelledby="lendModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lendModalLabel">Lend Form</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- Lend Form -->
          <form class="row g-5 mt-1" action="/community/borrow/" method="post"
            enctype="multipart/form-data"> {% csrf_token %}

            <div class="col-md-12 my-3">
                {{offering_form.as_p}}
            </div>

            <div class="col-12 my-2">
                <button type="submit" class="btn btn-outline-light btn-sm rounded-pill my-1">Upload</button>
            </div>
        </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!--borrow modal-->
  <div class="modal fade" id="BorrowModal" tabindex="-1" role="dialog" aria-labelledby="lendModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lendModalLabel">Borrow Form</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <!-- Borrow Form -->
          <form class="row g-5 mt-1" action="/community/lend/" method="post"
            enctype="multipart/form-data"> {% csrf_token %}

            <div class="col-md-12 my-3">
                {{demand_form.as_p}}
            </div>

            <div class="col-12 my-2">
                <button type="submit" class="btn btn-outline-light btn-sm rounded-pill my-1">Upload</button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <!-- <button type="button" class="btn btn-primary">Submit</button> -->
        </div>
      </div>
    </div>
  </div>

  <h5 class="my-4" style="color: #d4e4f9;">Latest deals</h5>
  <div class="row">

    {% if deals|length  == 0 %}
      <p class="text-light" style="margin: auto; text-align: center;"></p>No deals available!
    {% else %}
    {% for deal in deals %}
    <div class="col-md-4 my-4">
      <div class="card" style="background: #111827 !important; border: 1px solid #3a3a40 !important;">

        <div class="card-body" style="color: #d4e4f9;">
          <h5 class="card-title">{{deal.item.name}}</h5>
          <p class="card-text">{{deal.timeStamp}}</p>
          <button type="button" class="btn btn-light mt-3" onclick="document.location = '/community/deal/{{deal.id}}/closed'">
            View
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <h5 class="my-4" style="color: #d4e4f9;">Borrow Categories</h5>

  <div class="row my-2 mx-1"
    style="background: #111827 !important; border: 1px solid #3a3a40 !important; border-radius: 0.5rem;">

    {% if categories|length  == 0 %}
      <p class="text-light" style="margin: auto; text-align: center;"></p>No category added yet!
    {% else %}

    {% for category in categories %}
    <div class="col-md-4 py-3 mx-0" style="color: #d4e4f9; border-right: 1px solid #1d2432;">
      <h5 class="categories" onclick="document.location = '/community/borrow/#category-{{category}}'">{{category}}</h5>
    </div>
    {% endfor %}

    {% endif %}
  </div>

</div>

<!-- <div class="row mx-5 my-5 pl-5">
  <div class="chat-section col-md-7">
    <div class="chatbox" id="chatbox">
      {% for message in messages %}
      {% if message.sender.id == request.user.id %}
      <div class="messageBox px-3 my-1 py-1" style="margin-left: auto;" data-sender-id="{{ request.user.id }}"
        id="message-{{ message.id }}">
        {% else %}
        <div class="messageBox px-3 my-1 py-1" style="margin-right: auto;" data-sender-id="{{ request.user.id }}"
          id="message-{{ message.id }}">
          {% endif %}

          {{message.message}}
      </div>
      {% endfor %}

    </div>
    <div class="send mx-2 my-1">
      <input type="text" id="message-input" placeholder="Type your message...">
      <button id="send-button">Send</button>
    </div>
  </div>

  <script>
    function scrollToBottom() {
      var div = document.getElementById("chatbox");
      div.scrollTop = div.scrollHeight;
    }

    const chatLog = document.getElementById('chat-log');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const wsScheme = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsURL = `${wsScheme}//${window.location.host}`;

    // Modify the WebSocket URL with the appropriate path for individual or group messaging
    const roomName = '{{room_name}}'; // Replace with the actual receiver ID
    const socket = new WebSocket(`${wsURL}/ws/chat/${roomName}/`); // For individual messaging

    socket.onopen = function () {
      console.log('WebSocket connection established.');
    };

    socket.onmessage = function (event) {
      const data = JSON.parse(event.data);

      // Create a new div element for the message box
      const newMessageBox = document.createElement('div');
      newMessageBox.classList.add('messageBox', 'px-3', 'my-1', 'py-1');
      newMessageBox.setAttribute('data-sender-id', data.sender_id)
      newMessageBox.id = 'message-' + data.id; 

      newMessageBox.innerHTML = `${data.message}`;

      if (newMessageBox.dataset.senderId === '{{ request.user.id }}') {
        newMessageBox.style.marginLeft = 'auto';
      } else {
        newMessageBox.style.marginRight = 'auto';
      }

      // Select the parent element with class 'chatbox'
      const chatBoxParent = document.querySelector('.chatbox');

      // Append the new message box to the parent element
      chatBoxParent.appendChild(newMessageBox);

      scrollToBottom();
    };

    sendButton.addEventListener('click', function () {
      const message = messageInput.value;
      socket.send(JSON.stringify({ message: message}));
      messageInput.value = '';
    });

    messageInput.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });
  </script>    
</div> -->

    {% endblock body %}